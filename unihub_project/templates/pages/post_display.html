<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Social Media Posts</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f9;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .post {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      padding: 15px;
      display: flex;
      flex-direction: column;
    }
    .post img {
      max-width: 100%;
      max-height: 500px;
      height: auto;
      width: auto;
      display: block;
      margin: 0 auto;
    }
    .post h2 {
      font-size: 24px;
      margin-bottom: 10px;
      color: #4CAF50;
    }
    .post p {
      font-size: 16px;
      line-height: 1.6;
      margin-bottom: 10px;
    }
    .tags {
      font-size: 14px;
      color: #888;
      margin-bottom: 10px;
    }
    .post-footer {
      font-size: 14px;
      color: #888;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .post-footer .author {
      font-weight: bold;
    }
    .edit-button, .delete-button {
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 5px;
      text-align: center;
    }
    .edit-button {
      background-color: #4CAF50;
      color: white;
      border: none;
    }
    .edit-button:hover {
      background-color: #45a049;
    }
    .delete-button {
      background-color: #f44336;
      color: white;
      border: none;
    }
    .delete-button:hover {
      background-color: #e53935;
    }
    .like-button {
      background-color: #008CBA;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 5px;
    }
    .like-button:hover {
      background-color: #007bb5;
    }
    .comments {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #ddd;
    }
    .comments textarea {
      width: 100%;
      height: 50px;
      margin-top: 5px;
      padding: 5px;
    }
    .comment-button {
      margin-top: 5px;
      padding: 5px 10px;
      border: none;
      background-color: #ff9800;
      color: white;
      cursor: pointer;
      border-radius: 5px;
    }
    .comment-button:hover {
      background-color: #e68a00;
    }
    .reply-button {
      background-color: #6c757d;
      color: white;
      border: none;
      padding: 3px 8px;
      cursor: pointer;
      border-radius: 3px;
      font-size: 12px;
      margin-left: 10px;
    }
    .reply-button:hover {
      background-color: #5a6268;
    }
    .replying-to {
      font-size: 14px;
      color: #555;
      margin-top: 5px;
    }
    .cancel-reply {
      background-color: transparent;
      border: none;
      color: #007bff;
      cursor: pointer;
      font-size: 12px;
      margin-left: 5px;
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>All Posts</h1>
  
    {% for post in posts %}
    <div class="post">
      {% if post.image %}
      <img src="{{ post.image.url }}" alt="Post Image">
      {% endif %}
      <h2>{{ post.title }}</h2>
      <p>{{ post.content }}</p>
      <div class="tags">Tags: {{ post.tags }}</div>
  
      <!-- Post Footer with Like & Edit/Delete -->
      <div class="post-footer">
        <span class="author">{{ post.user.username }}</span> |
        <span>{{ post.created_at }}</span>
  
        <!-- Like Button -->
        {% if post.liked %}
        <button onclick="toggleLike({{ post.id }})" id="like-button-{{ post.id }}" class="like-button" data-liked="true">
          <i class="fas fa-thumbs-up"></i>
          <span id="like-text-{{ post.id }}">Unlike</span>
          (<span id="like-count-{{ post.id }}">{{ post.likes_count }}</span>)
        </button>
        {% else %}
        <button onclick="toggleLike({{ post.id }})" id="like-button-{{ post.id }}" class="like-button" data-liked="false">
          <i class="fas fa-thumbs-up"></i>
          <span id="like-text-{{ post.id }}">Like</span>
          (<span id="like-count-{{ post.id }}">{{ post.likes_count }}</span>)
        </button>
        {% endif %}
  
        {% if post.can_edit %}
          <form action="{% url 'edit_post' post.id %}" method="get" style="display:inline;">
            <button type="submit" class="edit-button">Edit Post</button>
          </form>
        {% endif %}
        <form action="{% url 'delete_post' post.id %}" method="post" style="display:inline;" onsubmit="return confirmDelete()">
          {% csrf_token %}
          <button type="submit" class="delete-button">Delete Post</button>
        </form>
      </div>
  
      <!-- Comments Section -->
      <div class="comments">
        <h3>Comments ({{ post.comments_count }})</h3>
        <!-- Hidden input to store parent comment ID when replying -->
        <input type="hidden" id="reply-parent-{{ post.id }}" value="">
        <!-- Div to display current reply target -->
        <div id="replying-to-{{ post.id }}" class="replying-to" style="display:none;"></div>
  
        <ul id="comments-list-{{ post.id }}">
          {% for comment in post.comments.all %}
          <li id="comment-{{ comment.id }}">
            <b>{{ comment.user.username }}:</b>
            <span id="comment-content-{{ comment.id }}">{{ comment.content }}</span>
            &nbsp;&nbsp;
            {% if comment.user == request.user %}
            <!-- Edit Button -->
            <a href="{% url 'edit_comment_page' comment.id %}" style="text-decoration:none;">
              <button class="edit-comment-button">✏️</button>
            </a>
            <!-- Delete Button -->
            <button class="delete-comment-button" onclick="deleteComment({{ comment.id }}, {{ post.id }})">❌</button>
            {% endif %}
            <!-- Reply Button  -->
            <button class="reply-button" onclick="replyToComment({{ post.id }}, '{{ comment.id }}', '{{ comment.user.username }}')">Reply</button>

  
            <!-- Replies List -->
            <ul id="replies-list-{{ comment.id }}">
              {% for reply in comment.replies.all %}
              <li id="comment-{{ reply.id }}">
                <b>{{ reply.user.username }}:</b>
                <span id="comment-content-{{ reply.id }}">{{ reply.content }}</span>
                &nbsp;&nbsp;
                {% if reply.user == request.user %}
                <a href="{% url 'edit_comment_page' reply.id %}" style="text-decoration:none;">
                  <button class="edit-comment-button">✏️</button>
                </a>
                <button class="delete-comment-button" onclick="deleteComment({{ reply.id }}, {{ post.id }})">❌</button>
                {% endif %}
              </li>
              {% endfor %}
            </ul>
          </li>
          {% endfor %}
        </ul>
        <!-- Comment Input for New Comments or Replies -->
        <textarea id="comment-input-{{ post.id }}" placeholder="Write a comment..."></textarea>
        <!-- cancel reply button -->
        <button class="cancel-reply" style="display:none;" id="cancel-reply-{{ post.id }}" onclick="cancelReply({{ post.id }})">Cancel Reply</button>

        <button onclick="addComment({{ post.id }})" class="comment-button">Comment</button>
      </div>
    </div>
    {% endfor %}
  </div>
  
  <script>
    function confirmDelete() {
      return confirm("Are you sure you want to delete this post?");
    }
    
    async function toggleLike(postId) {
      const likeButton = document.getElementById(`like-button-${postId}`);
      const likeText = document.getElementById(`like-text-${postId}`);
      const likeCount = document.getElementById(`like-count-${postId}`);
      
      const response = await fetch(`/api/post/like-post/${postId}/`, {
        method: "POST",
        credentials: "include",
        headers: { "X-CSRFToken": getCSRFToken() }
      });
      
      if (response.ok) {
        let data = await response.json();
        likeText.textContent = data.liked ? "Unlike" : "Like";
        likeCount.textContent = data.like_count;
        likeButton.setAttribute("data-liked", data.liked);
      }
    }
    
    async function addComment(postId) {
      const commentInput = document.getElementById(`comment-input-${postId}`);
      const content = commentInput.value.trim();
      if (!content) return;
      
      const parentInput = document.getElementById(`reply-parent-${postId}`);
      const parentId = parentInput.value || null;
      
      const response = await fetch(`/api/post/comment-post/${postId}/`, {
        method: "POST",
        credentials: "include",
        headers: {
          "X-CSRFToken": getCSRFToken(),
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ content: content, parent_id: parentId })
      });
      
      if (response.ok) {
        location.reload();
      }
    }
    
    async function deleteComment(commentId, postId) {
      const response = await fetch(`/api/post/delete-comment/${commentId}/`, {
        method: "DELETE",
        credentials: "include",
        headers: { "X-CSRFToken": getCSRFToken() }
      });
      if (response.ok) {
        location.reload();
      } else {
        alert("Failed to delete comment. Please try again.");
      }
    }
    function replyToComment(postId, commentId, username) {
        document.getElementById('reply-parent-' + postId).value = commentId;
        document.getElementById('comment-input-' + postId).placeholder = 'Replying to ' + username + '...';
        document.getElementById('replying-to-' + postId).style.display = 'inline';
        document.getElementById('replying-to-' + postId).textContent = 'Replying to ' + username;
        document.getElementById('cancel-reply-' + postId).style.display = 'inline';
      }
      
      function cancelReply(postId) {
        document.getElementById('reply-parent-' + postId).value = '';
        document.getElementById('comment-input-' + postId).placeholder = 'Write a comment...';
        document.getElementById('replying-to-' + postId).style.display = 'none';
        document.getElementById('cancel-reply-' + postId).style.display = 'none';
      }

    // This funtion has fixed everything 
        //         _.-/`)
        //         // / / )
        //      .=// / / / )
        //     //`/ / / / /
        //    // /     ` /
        //   ||         /
        //    \\       /
        //     ))    .'
        //    //    /

    
    function getCSRFToken() {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.startsWith("csrftoken=")) {
            cookieValue = cookie.substring("csrftoken=".length, cookie.length);
            break;
          }
        }
      }
      return cookieValue;
    }
  </script>
  
</body>
</html>
