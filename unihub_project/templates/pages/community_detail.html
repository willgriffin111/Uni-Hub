{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ community.name }} - UNI-HUB</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- FontAwesome -->
  <script src="https://kit.fontawesome.com/c43d240003.js" crossorigin="anonymous"></script>
  <!-- Custom CSS -->
  <link rel="stylesheet" href="{% static 'nav_footer.css' %}">
  <link rel="stylesheet" href="{% static 'create_community.css' %}">
</head>
<body>
  {% include '../includes/header.html' %}

  <div class="container post-container">
    <!-- Community Header -->
    <div class="page-header">
      <h1>{{ community.name }}</h1>
      <p>{{ community.description }}</p>
      <p>Contact: {{ community.contact_email }}</p>
      {% if community.logo %}
        <img src="{{ community.logo.url }}" alt="{{ community.name }} Logo" style="max-width:200px; max-height:200px;">
      {% endif %}
    </div>

    <!-- Community Posts -->
    <div class="section">
      <h3>Community Posts</h3>
      {% for post in posts %}
      <div class="post">
        <!-- Post Avatar -->
        <div class="post-avatar">
          <img src="{{ post.user.profile.image.url|default:'/static/bingus.jpg' }}" alt="{{ post.user.username }}">
        </div>
        <!-- Post Content -->
        <div class="post-content">
          <div class="post-header">
            <div class="post-user-info">
              <h4 class="post-author">{{ post.user.username }}</h4>
              <span class="post-time">Â· {{ post.created_at|timesince }} ago</span>
            </div>
            <div class="post-options">
              <button class="options-btn"><i class="fa-solid fa-ellipsis"></i></button>
            </div>
          </div>
          <div class="post-text">
            <h4>{{ post.title }}</h4>
            <p>{{ post.content }}</p>
          </div>
          <div class="tags">Tags: {{ post.tags }}</div>
          {% if post.image %}
          <div class="post-media">
            <img src="{{ post.image.url }}" alt="Post Image">
          </div>
          {% endif %}
          <!-- Post Actions -->
          <div class="post-actions">
            {% if post.liked %}
            <button onclick="toggleLike({{ post.id }})" id="like-button-{{ post.id }}" class="post-action-btn like-btn" data-liked="true">
              <i class="fas fa-thumbs-up"></i>
              <span id="like-text-{{ post.id }}">Unlike</span>
              (<span id="like-count-{{ post.id }}">{{ post.likes_count }}</span>)
            </button>
            {% else %}
            <button onclick="toggleLike({{ post.id }})" id="like-button-{{ post.id }}" class="post-action-btn like-btn" data-liked="false">
              <i class="fas fa-thumbs-up"></i>
              <span id="like-text-{{ post.id }}">Like</span>
              (<span id="like-count-{{ post.id }}">{{ post.likes_count }}</span>)
            </button>
            {% endif %}
          </div>
        </div>
      </div>
      {% empty %}
      <p>No posts in this community yet.</p>
      {% endfor %}
    </div>
  </div>

  {% include '../includes/footer.html' %}

  <script>
    // (Include your JavaScript functions for like toggling etc. here, similar to your other pages)
    function getCSRFToken() {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.startsWith("csrftoken=")) {
            cookieValue = cookie.substring("csrftoken=".length, cookie.length);
            break;
          }
        }
      }
      return cookieValue;
    }

    async function toggleLike(postId) {
      const likeButton = document.getElementById(`like-button-${postId}`);
      const likeText = document.getElementById(`like-text-${postId}`);
      const likeCount = document.getElementById(`like-count-${postId}`);
      
      const response = await fetch(`/api/post/like-post/${postId}/`, {
        method: "POST",
        credentials: "include",
        headers: { "X-CSRFToken": getCSRFToken() }
      });
      
      if (response.ok) {
        let data = await response.json();
        likeText.textContent = data.liked ? "Unlike" : "Like";
        likeCount.textContent = data.like_count;
        likeButton.setAttribute("data-liked", data.liked);
      }
    }
  </script>
</body>
</html>
